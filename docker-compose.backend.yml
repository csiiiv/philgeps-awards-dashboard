# ==============================================================================
# PhilGEPS Backend Services - Docker Compose
# ==============================================================================
# Backend API + Queue System (RabbitMQ, Redis, Celery, Flower)
# Deploy this on your backend cloud service (e.g., Azure Container Instances)
#
# Usage:
#   docker compose -f docker-compose.backend.yml up -d
#
# Requirements:
#   - .env file with configuration (see env.backend.example)
# ==============================================================================

services:
  # ==============================================================================
  # Backend API (Django + Daphne for WebSocket support)
  # ==============================================================================
  backend:
    build:
      context: ./backend/django
      dockerfile: Dockerfile
    image: philgeps-backend:latest
    container_name: philgeps-backend
    ports:
      - "${BACKEND_PORT:-3200}:8000"
    networks:
      - philgeps-network
    environment:
      SECRET_KEY: ${SECRET_KEY:-django-insecure-dev-key}
      DEBUG: ${DEBUG:-False}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-}
      CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS:-}
      USE_TMPFS_PARQUET: ${USE_TMPFS_PARQUET:-true}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-amqp://guest:guest@rabbitmq:5672//}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/0}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_HOST: ${REDIS_HOST:-redis}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-300}
      GUNICORN_GRACEFUL_TIMEOUT: ${GUNICORN_GRACEFUL_TIMEOUT:-330}
      GUNICORN_KEEPALIVE: ${GUNICORN_KEEPALIVE:-5}
      GUNICORN_LOG_LEVEL: ${GUNICORN_LOG_LEVEL:-info}
      GUNICORN_ACCESS_LOG: "-"
      GUNICORN_ERROR_LOG: "-"
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    tmpfs:
      - /data/parquet-tmpfs:size=3221225472,mode=1777
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ==============================================================================
  # Redis - Result Backend & Cache
  # ==============================================================================
  redis:
    image: redis:7-alpine
    container_name: philgeps-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - philgeps-network
    command: redis-server --maxmemory ${REDIS_MAX_MEMORY:-512mb} --maxmemory-policy allkeys-lru
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - redis_data:/data
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==============================================================================
  # RabbitMQ - Message Broker
  # ==============================================================================
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: philgeps-rabbitmq
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MGMT_PORT:-15672}:15672"
    networks:
      - philgeps-network
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==============================================================================
  # Celery Worker - Background Task Processor
  # ==============================================================================
  celeryworker:
    build:
      context: ./backend/django
      dockerfile: Dockerfile
    image: philgeps-celeryworker:latest
    container_name: philgeps-celeryworker
    command: celery -A philgeps_data_explorer worker --loglevel=info --concurrency=${CELERY_WORKER_CONCURRENCY:-4}
    networks:
      - philgeps-network
    environment:
      SECRET_KEY: ${SECRET_KEY:-django-insecure-dev-key}
      DEBUG: ${DEBUG:-False}
      DJANGO_SETTINGS_MODULE: "philgeps_data_explorer.settings"
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-amqp://guest:guest@rabbitmq:5672//}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/0}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_HOST: ${REDIS_HOST:-redis}
      USE_TMPFS_PARQUET: ${USE_TMPFS_PARQUET:-true}
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    tmpfs:
      - /data/parquet-tmpfs:size=3221225472,mode=1777
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ==============================================================================
  # Celery Beat - Periodic Task Scheduler
  # ==============================================================================
  celerybeat:
    build:
      context: ./backend/django
      dockerfile: Dockerfile
    image: philgeps-celeryworker:latest
    container_name: philgeps-celerybeat
    command: celery -A philgeps_data_explorer beat --loglevel=info
    networks:
      - philgeps-network
    environment:
      SECRET_KEY: ${SECRET_KEY:-django-insecure-dev-key}
      DEBUG: ${DEBUG:-False}
      DJANGO_SETTINGS_MODULE: "philgeps_data_explorer.settings"
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-amqp://guest:guest@rabbitmq:5672//}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/0}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      REDIS_HOST: ${REDIS_HOST:-redis}
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==============================================================================
  # Flower - Celery Monitoring Dashboard (Optional)
  # ==============================================================================
  flower:
    build:
      context: ./backend/django
      dockerfile: Dockerfile
    image: philgeps-backend:latest
    container_name: philgeps-flower
    command: celery -A philgeps_data_explorer flower --port=5555
    ports:
      - "${FLOWER_PORT:-5555}:5555"
    networks:
      - philgeps-network
    environment:
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-amqp://guest:guest@rabbitmq:5672//}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/0}
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    profiles:
      - monitoring  # Only start if explicitly requested

# ==============================================================================
# Networks
# ==============================================================================
networks:
  philgeps-network:
    driver: bridge
    name: philgeps-backend-network

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  redis_data:
    name: philgeps-redis-data
  rabbitmq_data:
    name: philgeps-rabbitmq-data

# ==============================================================================
# Notes:
# ==============================================================================
# 
# 1. Deploy backend services:
#    docker compose -f docker-compose.backend.yml up -d
#
# 2. With monitoring (Flower):
#    docker compose -f docker-compose.backend.yml --profile monitoring up -d
#
# 3. View logs:
#    docker compose -f docker-compose.backend.yml logs -f backend
#
# 4. Scale workers:
#    docker compose -f docker-compose.backend.yml up -d --scale celeryworker=4
#
# 5. Check health:
#    docker compose -f docker-compose.backend.yml ps
#
# ==============================================================================

