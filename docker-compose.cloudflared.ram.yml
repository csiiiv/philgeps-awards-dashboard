services:
  backend:
    build:
      context: ./backend/django
      dockerfile: Dockerfile
    image: philgeps-backend:latest
    container_name: philgeps-backend-ram
    ports:
      - "3200:8000"
    environment:
      # Development mode for local access
      DEBUG: "True"
      # Django settings
      ALLOWED_HOSTS: "localhost,127.0.0.1"
      CORS_ALLOWED_ORIGINS: "http://localhost:3000,http://localhost:5173,http://127.0.0.1:3000,http://127.0.0.1:5173"
      CSRF_TRUSTED_ORIGINS: "http://localhost:3000,http://localhost:5173"
      SECRET_KEY: "your-secret-key"
      # Enable RAM disk optimization (entrypoint will set PARQUET_DIR)
      USE_TMPFS_PARQUET: "true"
      # Gunicorn settings optimized for 40-50 concurrent users
      GUNICORN_WORKERS: "4"
      GUNICORN_WORKER_CLASS: "gevent"
      GUNICORN_WORKER_CONNECTIONS: "1000"
      GUNICORN_TIMEOUT: "120"
      GUNICORN_GRACEFUL_TIMEOUT: "125"
      GUNICORN_KEEPALIVE: "75"
      # Database connection pooling
      DB_CONN_MAX_AGE: "600"
      # Redis cache enabled (using django-redis backend)
      REDIS_URL: "redis://redis:6379/0"
      CACHE_BACKEND: "django_redis.cache.RedisCache"
      CACHE_TIMEOUT: "300"
      # Python logging
      PYTHONUNBUFFERED: "1"
    # RAM disk for parquet data (3GB for 2.0GB of data)
    tmpfs:
      - /data/parquet-tmpfs:size=3221225472,mode=1777
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      args:
        VITE_API_URL: http://localhost:3200
    image: philgeps-frontend:latest
    container_name: philgeps-frontend
    ports:
      - "3000:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      backend:
        condition: service_healthy

  redis:
    image: redis:7-alpine
    container_name: philgeps-redis
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # cloudflared:
  #   image: cloudflare/cloudflared:latest
  #   restart: unless-stopped
  #   command: tunnel --no-autoupdate run
  #   environment:
  #     TUNNEL_TOKEN: "<your-cloudflare-tunnel-token>"
  #   depends_on:
  #     - backend
  #     - frontend

networks:
  default:
    driver: bridge
